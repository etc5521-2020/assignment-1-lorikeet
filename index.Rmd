---
title: "ETC5521 Assignment 1"
subtitle: "Measles Vaccination"
team: Lorikeet
author:
  - Aryan Jain
  - Emily Sheehan
  - Jimmy Effendy
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE)
```

```{r libraries}
# Load libraries
library(tidyverse)
library(scales)
library(ggrepel)
library(knitr)
library(kableExtra)
library(naniar)
library(ggplot2)
library(mapview)
library(sf)
library(maps)
library(tools)
library(ggpubr)
library(plotly)
library(here)
```

```{r load-data}
# Read in data from github
#measles <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-25/measles.csv')

#state_income <- readr::read_csv('https://raw.githubusercontent.com/TaxFoundation/facts-and-figures/master/42-income-per-capita-by-state.csv') %>%
  #filter(id != 0)

#Read in data from repo
measles <- read_csv(here::here("data/measles.csv"))
state_income <- read_csv(here::here("data/state_income.csv"))
educational_attainment <- read_csv(here::here("data/educational_attainment.csv"))
migration <- read_csv(here::here("data/migration.csv"))
```


# Introduction and motivation

Measles is a highly infectious disease caused by the Measles virus. It can lead to pneumonia, infections of the middle ear, swelling of the brain and death.

A vaccine exists to prevent the onset of measles as there is no treatment. The vaccine involves the injection of attenuated measles antigens that stimulate the production of antibodies and memory cells, providing long-term protection against the virus. When administered properly, the vaccine is 90.5% effective within 72 hours of exposure (Barrabeig et al., 2011).

Unfortunately there is a growing number of individuals refusing vaccination, particularly in the US (Phadke et al., 2016). In Texas, the number of unvaccinated children attaining exemptions to attend school has increased by 28 times since 2003 (Sinclair et al., 2019). This has led to several outbreaks of vaccine preventable diseases, such as Measles. If this trend continues, there could be calamitous consequences. 

This paper hopes to determine whether there is a relationship between socioeconomic status and vaccination rate. Specifically, it explores whether MMR vaccination rates are higher in private schools, how the MMR vaccination rate compares to the overall vaccination rate and compares the average per capita income across the states with the highest and lowest vaccination rates. 

To analyse the relationship a dataset was retrieved from Wall Street Journal. Although every precaution has been taken to ensure accurate figures have been calculated, some of the MMR rates, overall vaccination rates and school types were missing from the original dataset. The missing data was identified using _vis_miss_ in the _naniar_ package, and removed to reduce the impact on the figures calculated. 

```{r find-missing-data, include=FALSE}
# Analyse how many variables are missing
naniar::vis_miss(measles, warn_large_data = FALSE)
```

# Data description

The data comprises of vaccination rates for 46,412 schools in 32 U.S states and was retrieved from The Wall Street Journal. The variables include; the school academic year, the school's state, city, county, district, name, type, enrollment, MMR (measles, mumps and rubella) vaccination rate, overall vaccination rate, latitude, longitude and the percentage of students exempted from vaccinations due to personal, religious or medical reasons. 

The data was collected in the 2017-18 school year for 11 states and 2018-19 school year for the remaining 21 states. The state health departments provided the vaccination data and the National Center for Education Statistic's provided the school location, which was matched against the school name. In the case that there was no match, the school's location was found with Google Maps API. 

The individual state dataset was scraped from the Tidy Tuesday Github repository and combined with the existing measles dataset with *left_join* to extract the longitude and latitude variables from it. Various functions from the *rvest* package were used to scrape the data including *read_html* and *html_table*. 

**Primary Question**: Does Measles vaccination rate improve with better socioeconomic conditions?

**Secondary Questions**:

- Are the MMR vaccination rates higher in private schools?
- How does the MMR vaccination rate compare to the school's overall vaccination rate?
- Which states have the highest and lowest vaccination rates?
- What is the average income in the states with the highest and lowest vaccination rate?

# Analysis and findings

## Are the MMR vaccination rates higher in private schools?

The measles data was filtered to remove missing school type, overall vaccination rate and MMR rate. It was grouped by type of school and the average MMR vaccination rate and overall vaccination rate was calculated using the _mean_ function. The tibble generated was named _school_type_average_. Then, the average MMR rates from the  _school_type_average_ tibble were plotted. The rates were annotated accordingly, to draw attention to the difference between the MMR vaccination rate for each school type. 

```{r school-type-average}
school_type_average <- 
  measles %>%
  # remove missing data
  filter(type != "NA",
         mmr != -1,
         overall != -1) %>%
  # group by type of school
  group_by(type) %>%
  # calculate the average mmr rate and overall rate according to type of school
  summarise(average_mmr_rate = mean(mmr),
            average_vacc_rate = mean(overall))%>%
  select(type,average_mmr_rate)
```

```{r ggplot-MMR-school-type}
ggplot(school_type_average,
       aes(x = "",
           y = average_mmr_rate,
           group = type)) +
  geom_bar(stat = "identity", width = 1) +
  facet_wrap(~type) +
  # convert to a pie chart
  coord_polar("y", start = 0) +
  # get rid of axis labels
  theme_void() +
  # add a percentage label to each segment which is colour co-ordinated
  geom_label_repel(label = percent(school_type_average$average_mmr_rate/100),
                  size= 3,
                   show.legend = F) +
  # add a title
  ggtitle("The Average MMR Vaccination Rate according to School Type")
```

The overall vaccination rate and the MMR vaccination rate was the highest in public schools, as seen in the pie chart above. This is consistent with findings from a study conducted by Shaw (2014) where it was found that private schools have higher rates of exemptions for immunisations than public schools.

## How does the MMR vaccination rate compare to the school's overall vaccination rate?

The _school_type_average_ data was tabulated to compare the overall vaccination rate and MMR vaccination rate. Then, both rates were plotted according to school type. 

```{r summary-overall-mmr}
school_type_average %>%
  # convert rates to a percentage
  mutate(average_mmr_rate = percent(average_mmr_rate/100)) %>%
  # change column names
  kable(col.names = c("Type",
                      "Average MMR Vaccination Rate"),
        # add a caption
        caption = "Comparison of both Average Vaccination Rates according to School Type") %>%
  kable_styling(full_width = TRUE)
```

```{r school-type}
school_type <- 
  measles %>%
  # remove missing data
  filter(type != "NA",
         mmr != -1,
         overall != -1) %>%
  # group by type of school
  group_by(type)%>%
  mutate(averageMMR = mean(mmr))
  # calculate the average mmr rate and overall rate according to type of school
  
  
  
 school_type
```

When comparing the vaccination rates according to school type, it is clear that the overall vaccination rate is lower than the MMR vaccination rate for all school types as seen in the plot below. Public schools have the highest overall vaccination rate and MMR rate. 

```{r vacc-rates-ggplot}
ggplot(school_type ,
         aes(x = type,
             y = mmr)) +geom_boxplot(aes(fill=type))+
  #geom_vline(average = averageMMR)+

  facet_wrap(~type,scales="free")+xlab("Type of school")+ylab("MMR vaccination Rate")+ggtitle("The school MMr vaccination Rate")
```


## Which states have the highest and lowest vaccination rates?

The measles data was grouped by state and then the average MMR and overall vaccination rate were calculated. Then, the _map_data_ function was used to create a tibble containing the geographical information of each state. This data was merged with the _measles_states_ data, which contains the average MMR and overall vaccination rate for each state. Any missing data or negative values were removed and the remaining data was plotted onto a map and bar chart using _geom_polygon_ and _geom_col_, respectively. The _ggplotly_ function was used to make the maps interactive. 


```{r density-summary}
# Measles vaccination across all American states and school count
measles_density <- measles %>%
  group_by(state) %>%
  summarise(mmr = mean(mmr),
            overall = mean(overall),
            count = n())

# Measles vaccination across state
measles_states <- measles_density[c("state", 
                                    "mmr", 
                                    "overall")] %>%
  rename(region = state) %>%
  mutate(region = tolower(region))
```

```{r map-data}
# Use map_data() to create usa mapping dataframe
usa <- map_data("state")

# Merging usa map data with measles across state data
usa_measles_states <- merge(usa, 
                            measles_states, 
                            all.x = TRUE)

# finding centroids and abb of each state
states <- st_as_sf(map("state", 
                       plot = FALSE, 
                       fill = TRUE))
states <- cbind(states, 
                st_coordinates(st_centroid(states)))
states$abb <- state.abb[match(states$ID,tolower(state.name))]

# Merging measles state data and usa map data with centroid data
usa_measles_states <- merge(usa_measles_states, 
                            states[c("ID", "X", "Y", "abb")], 
                            by.x = "region", 
                            by.y = "ID") %>%
  ungroup() %>%
  arrange(order)

# filter the missing data out
usa_measles_states_overall <- usa_measles_states %>%
  filter(overall > 0)

usa_measles_states_mmr <- usa_measles_states %>%
  filter(mmr > 0)
```

```{r mmr-map}
# MMR vaccination rate across the states
# add ggplotly to make the plot interactive
mmr_p <- ggplotly(ggplot(usa_measles_states_mmr, aes(long, 
                                            lat, 
                                            group=group, 
                                            fill=mmr)) +
  geom_polygon(color = "light grey") +
  geom_text(aes(X, Y, 
                label = abb), 
            size = 4,
            color = "white",
            family = "sans") +
    # add title and x and y axis and remove the legend
  ggtitle("MMR Vaccination Rate across States") +
  xlab("Latitude") +
  ylab("Longitude") + 
  theme(legend.position = "none"))
mmr_p
```

```{r overall-map}
# Overall vaccination rate across states
# add ggplotly to make the plot interactive
overall_p <- ggplotly(ggplot(usa_measles_states_overall, 
                    aes(long, 
                        lat, 
                        group=group, 
                        fill=overall)) +
  geom_polygon(color="light grey")+
  geom_text(aes(X, Y, label = abb), 
            size = 4,
            color="white",
            family="sans") +
    # add a title and x and y axis
  ggtitle("Overall Vaccination Rate Across States") +
  xlab("Latitude") +
  ylab("Longitude") +
    # remove the legend
  theme(legend.position = "none"))
overall_p
```

```{r overall-state-plot}
measles_density_overall <- measles_density %>%
  filter(overall > 0)

p_overall <- ggplot(measles_density_overall, 
                    aes(y = fct_reorder(state,
                                        overall), 
                        x = overall,
                        # fill according to overall vaccination rate
                        fill = overall)) +
  geom_col() +
  # add x and y axis labels
  xlab("Overall Vaccination Rate") +
  ylab("") +
  #remove axis ticks, legend and panel background
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  # label the plot with percentages
  geom_label_repel(label = percent(measles_density_overall$overall/100),
                  size= 2,
                  color = "white",
                  show.legend = F) 
```

```{r mmr-state-plot}
measles_density_mmr <- measles_density %>%
  filter(mmr > 0)

p_mmr <- ggplot(measles_density_mmr, 
                aes(y = fct_reorder(state, 
                                    mmr),
                    x = mmr,
                    # fill according to mmr vaccination rate
                    fill = mmr)) +
  geom_col() +
  # add x and y axis labels
  xlab("MMR Vaccination Rate") +
  ylab("") +
  #remove axis ticks, legend and panel background
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  # label the plot with percentages
  geom_label_repel(label = percent(measles_density_mmr$mmr/100),
                  size= 2,
                  color = "white",
                  show.legend = F) 
```

The state with the highest MMR vaccination rate is Illinois at 97.39% and the state with the lowest MMR vaccination rate is Massachusetts at 57.68% as shown in the figure below. 

```{r arrange-mmr-overall, fig.cap="**The Overall and MMR Vaccination Rate, according to State**"}
# arrange both plots so they appear side-by-side
ggpubr::ggarrange(p_overall, 
                  p_mmr, 
                  nrow=1)
```

The state with the highest overall vaccination rate is North Caroline at 96.779%, while the state with the lowest vaccination rate is Washington at 75.238% as shown in the figure above. It is difficult to compare the individual states MMR vaccination rate with the overall vaccination rate due to the missing data. However, California, Vermont, Ohio and Oregon have similar MMR and overall vaccination rates. 

## What is the average income in the states with the highest and lowest vaccination rate?

To analyse the average income of the states with the highest and lowest vaccination rate, an external dataset from [Tax Foundation:Github Repository](https://github.com/TaxFoundation/facts-and-figures) was retrieved. This data was merged with the measles data grouped by state, and the top and bottom five observations were tabulated for both the vaccination rates. The vaccination rate and income data were plotted using _geom_col_ and _gg_arrange_, and ordered in descending order. 

```{r measles-density-income}
measles_density_mmr_income <- measles_density_mmr %>% 
  # merge the data
  merge(state_income[c("stateName", 
                       "incomePerCapita")], 
        by.x = "state", 
        by.y = "stateName")
```

```{r best-mmr}
measles_density_mmr_income %>%
  select(state, 
         mmr, 
         incomePerCapita) %>%
  # convert mmr to a percentage
  mutate(mmr = percent(measles_density_mmr_income$mmr/100)) %>%
  # rename the column names
  rename(State = state, 
         MMR = mmr, 
         PCI = incomePerCapita) %>%
  arrange(desc(MMR)) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  # add a caption
  kable(caption = "The PCI of the States with the Highest MMR Vaccination Rate") %>%
  kable_styling()
```

```{r worst-mmr}
measles_density_mmr_income %>%
  select(state, 
         mmr, 
         incomePerCapita) %>%
  # convert mmr to percentage
    mutate(mmr = percent(measles_density_mmr_income$mmr/100)) %>%
  rename(State = state, 
         MMR = mmr, 
         PCI = incomePerCapita) %>%
  arrange(MMR) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  # add a caption
  kable(caption = "The PCI of the States with the Lowest MMR Vaccination Rate") %>%
  kable_styling()
```

The states with the highest MMR vaccination rate were; Illinois, Pennsylvania, Utah, Colorado and New York. These states each have an average per capita income of \$56,839,	\$56,225, \$46,320, \$58,456 and \$68,668, respectively, as shown in the plot below.

```{r mmr-income-plot}
p_mmr_income <- ggplot(measles_density_mmr_income, 
                       aes(y = fct_reorder(state,
                                           mmr))) +
  geom_col(aes(x = incomePerCapita)) +
  xlab("Income Per Capita") +
  ylab("") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  # add labels to the figure 
  geom_label_repel(aes(x = incomePerCapita),
                  label = dollar(measles_density_mmr_income$incomePerCapita),
                  size= 2,
                  show.legend = F) 
```

```{r arrange-mmr-income, fig.cap= "**The MMR Vaccination Rate and PCI of each State**"}
ggarrange(p_mmr, 
          p_mmr_income, 
          nrow = 1) 
```

The states with the lowest MMR vaccination rate were Massachusetts, Connecticut, Arizona, Montana and Washington. Interestingly enough, Massachusetts and Connecticut report two of the highest average per capita incomes as seen in the figure above. 

```{r merge-measles-overall-income}
measles_density_overall_income <- measles_density_overall %>%
  # merge the tables
  merge(state_income[c("stateName", 
                       "incomePerCapita")], 
        by.x = "state", 
        by.y = "stateName")
```

```{r best-overall}
measles_density_overall_income %>%
  select(state, 
         overall, 
         incomePerCapita) %>%
  # convert overall vaccination rate to a percentage
  mutate(overall = percent(measles_density_overall_income$overall/100)) %>%
  rename(State = state, 
         Overall = overall, 
         PCI = incomePerCapita) %>%
  arrange(desc(Overall)) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  # add a caption
  kable(caption = "The PCI of the States with the Highest Overall Vaccination Rate") %>%
  kable_styling()
```

```{r worst-overall}
measles_density_overall_income %>%
  select(state, 
         overall, 
         incomePerCapita) %>%
  # convert to a percentage
  mutate(overall = percent(measles_density_overall_income$overall/100)) %>%
  rename(State = state, 
         Overall = overall, 
         PCI = incomePerCapita) %>%
  arrange(Overall) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  # add a caption
  kable(caption = "The PCI of the States with the Lowest Overall Vaccination Rate") %>%
  kable_styling()
```

```{r overall-income-plot}
p_overall_income <- ggplot(measles_density_overall_income, 
                           aes(y = fct_reorder(state,
                                               overall))) +
  geom_col(aes(x = incomePerCapita)) +
  xlab("Income Per Capita") +
  ylab("") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  # annotate the figure with the pci
  geom_label_repel(aes(x = incomePerCapita),
                  label = dollar(measles_density_overall_income$incomePerCapita),
                  size= 2,
                  show.legend = F) 
```

The states with the highest overall vaccination rate were North Carolina, Tennessee, Florida, Michigan and Oregon. They had an average per capita income that ranged from $46,117 to $50,843, which is quite low when compared to the other incomes in the plot. The states with the lowest overall vaccination rate were Washington, Oklahoma, Idaho, Iowa and Ohio. Idaho had the lowest per capita income, however, Washington had one of the highest per capita income's at $62,026, as seen in the figure below. 

```{r arrange-overall-income, fig.cap="**The Overall Vaccination Rate and PCI of each State**"}
ggarrange(p_overall, 
          p_overall_income, 
          nrow = 1)
```

# Conclusion

The analysis has revealed that it is likely that there is no association with socioeconomic status and vaccination rates. Private schools, which are more expensive than public schools thus inferring greater socioeconomic status, have a lower average MMR and average overall vaccination rate than their public counterparts. The two states with the lowest MMR vaccination rate; Connecticut and Massachusetts, had the two highest average per capita incomes. Similarly, Washington had the lowest overall vaccination rate and one of the highest average per capita incomes. Therefore, it is unlikely that vaccination rate improves with socioeconomic status. 

# References

Alboukadel Kassambara (2020). ggpubr: 'ggplot2' Based
  Publication Ready Plots. R package version 0.4.0.
  https://CRAN.R-project.org/package=ggpubr
  
Barrabeig, I., Rovira, A., Rius, C., Muñoz, P., Soldevila, N., Batalla, J., &
  Domínguez, A. (2011). Effectiveness of measles vaccination for control of exposed children. The
  Pediatric Infectious Disease Journal, 30(1), 78–80.

C. Sievert. Interactive Web-Based Data Visualization with R,
  plotly, and shiny. Chapman and Hall/CRC Florida, 2020.

Cockcroft, A., Usman, M. U., Nyamucherera, O. F., Emori, H., Duke, B., Umar, N.
  A., & Andersson, N. (2014). Why children are not vaccinated against measles: a
  cross-sectional study in two Nigerian States. Archives of Public Health = Archives Belges de Sante
  Publique, 72(1), 48.

Commonwealth of Australia. (2020, May 27). Measles. Retrieved 25 August 2020, from
  https://www.health.gov.au/health-topics/measles#what-is-measles

Hadley Wickham and Dana Seidel (2020). scales: Scale
  Functions for Visualization. R package version 1.1.1.
  https://CRAN.R-project.org/package=scales
  
H. Wickham. ggplot2: Elegant Graphics for Data Analysis.
  Springer-Verlag New York, 2016.
  
Hao Zhu (2019). kableExtra: Construct Complex Table with
  'kable' and Pipe Syntax. R package version 1.1.0.
  https://CRAN.R-project.org/package=kableExtra
  
Kamil Slowikowski (2020). ggrepel: Automatically Position
  Non-Overlapping Text Labels with 'ggplot2'. R package version
  0.8.2. https://CRAN.R-project.org/package=ggrepel
  
Mock, T. (2018). TidyTuesday–W weekly social data project in R. URL:
  https://github. com/rfordatascience/tidytuesday, 3.  

Nicholas Tierney, Di Cook, Miles McBain and Colin Fay (2020).
  naniar: Data Structures, Summaries, and Visualisations for
  Missing Data. R package version 0.5.2.
  https://CRAN.R-project.org/package=naniar  
  
Original S code by Richard A. Becker, Allan R. Wilks. R
  version by Ray Brownrigg. Enhancements by Thomas P Minka and
  Alex Deckmyn. (2018). maps: Draw Geographical Maps. R package
  version 3.3.0. https://CRAN.R-project.org/package=maps

Pebesma, E., 2018. Simple Features for R: Standardized
  Support for Spatial Vector Data. The R Journal 10 (1),
  439-446, https://doi.org/10.32614/RJ-2018-009  
  
Phadke, V. K., Bednarczyk, R. A., Salmon, D. A., & Omer, S. B. (2016). Association Between
  Vaccine Refusal and Vaccine-Preventable Diseases in the United States: A Review of Measles and
  Pertussis. JAMA: The Journal of the American Medical Association, 315(11), 1149–1158. 
  
Queensland Health. (2019, October 22). What is measles and why do we vaccinate against it?
  Retrieved 25 August 2020, from
  https://www.health.qld.gov.au/news-events/news/what-is-measles-why-vaccinate#:~:text=The%20
  easles%20vaccine%20contains%20a,is%20better%20prepared%20to%20respond
  
R Core Team (2020). R: A language and environment for
  statistical computing. R Foundation for Statistical
  Computing, Vienna, Austria. URL https://www.R-project.org/.
  
Sinclair, D. R., Grefenstette, J. J., Krauland, M. G., Galloway, D. D., Frankeny, R. J.,
  Travis, C., … Roberts, M. S. (2019). Forecasted Size of Measles Outbreaks Associated With
  Vaccination Exemptions for Schoolchildren. JAMA Network Open, 2(8), e199768.

Shaw, J., Tserenpuntsag, B., McNutt, L.-A., & Halsey, N. (2014). United States private schools
  have higher rates of exemptions to school immunization requirements than public schools. The
  Journal of Pediatrics, 165(1), 129–133.  
  
Tim Appelhans, Florian Detsch, Christoph Reudenbach and
  Stefan Woellauer (2020). mapview: Interactive Viewing of
  Spatial Data in R. R package version 2.9.0.
  https://CRAN.R-project.org/package=mapview  

VanAntwerp, T. (2016). TaxFoundation facts-and-figures. GitHub repository.
  Retrieved from https://github.com/TaxFoundation/facts-and-figures

Wickham et al., (2019). Welcome to the tidyverse. Journal of
  Open Source Software, 4(43), 1686,
  https://doi.org/10.21105/joss.01686
  
Yihui Xie (2020). knitr: A General-Purpose Package for
  Dynamic Report Generation in R. R package version 1.29.

  Yihui Xie (2015) Dynamic Documents with R and knitr. 2nd
  edition. Chapman and Hall/CRC. ISBN 978-1498716963

  Yihui Xie (2014) knitr: A Comprehensive Tool for Reproducible
  Research in R. In Victoria Stodden, Friedrich Leisch and
  Roger D. Peng, editors, Implementing Reproducible
  Computational Research. Chapman and Hall/CRC. ISBN
  978-1466561595
  








