---
title: "ETC5521 Assignment 1"
subtitle: "Measles Vaccination"
team: Lorikeet
author:
  - Aryan Jain
  - Emily Sheehan
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE)
```

```{r libraries}
library(tidyverse)
library(scales)
library(ggrepel)
library(knitr)
library(kableExtra)
library(naniar)
library(ggplot2)
library(mapview)
library(sf)
library(maps)
library(tools)
library(ggpubr)
library(plotly)
```

```{r load-data}
measles <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-25/measles.csv')

state_income <- readr::read_csv('https://raw.githubusercontent.com/TaxFoundation/facts-and-figures/master/42-income-per-capita-by-state.csv') %>%
  filter(id != 0)
```

# Introduction and motivation

Measles is a highly infectious disease caused by the Measles virus. It can lead to pneumonia, infections of the middle ear, swelling of the brain and death.

A vaccine exists to prevent the onset of measles as there is no treatment. The vaccine involves the injection of attenuated measles antigens that stimulate the production of antibodies and memory cells, providing long-term protection against the virus. When administered properly, the vaccine is 90.5% effective within 72 hours of exposure (Barrabeig et al., 2011).

Unfortunately there is a growing number of individuals refusing vaccination, particularly in the US (Phadke et al., 2016). In Texas, the number of unvaccinated children attaining exemptions to attend school has increased by 28 times since 2003 (Sinclair et al., 2019). This has led to several outbreaks of vaccine preventable diseases, such as Measles. If this trend continues, there could be calamitous consequences. 

This paper hopes to understand the reasons for vaccine refusal and determine whether there is a relationship between socio-economic status and vaccination rate. To analyse the relationship a dataset has been scraped from WSJ github repository. Although every precaution has been taken to ensure accurate figures have been calculated, some of the MMR rates, overall vaccination rates and school types were missing from the original dataset. The missing data was identified using _naniar_, and removed to reduce the impact on the figures calculated. 

```{r find-missing-data, include=FALSE}
naniar::vis_miss(measles, warn_large_data = FALSE)
```

PERHAPS EXPLAIN DATA SOURCES IN MORE DETAIL

# Data description

The data comprises of vaccination rates for 46,412 schools in 32 U.S states and was retrieved from The Wall Street Journal. The variables include; the school academic year, the school's state, city, county, district, name, type, enrollment, MMR (measles, mumps and rubella) vaccination rate, overall vaccination rate, latitude, longitude and the percentage of students exempted from vaccinations due to personal, religious or medical reasons. 

The data was collected in the 2017-18 school year for 11 states and 2018-19 school year for the remaining 21 states. The state health departments provided the vaccination data and the National Center for Education Statistic's provided the school location, which was matched against the school name. In the case that there was no match, the school's location was found with Google Maps API. 

The individual state dataset was scraped from WSJ github repository and combined with the existing measles dataset with *left_join* to extract the longitude and latitude variables from it. Various functions from the *rvest* package were used to scrape the data including *read_html* and *html_table*. 

**Primary Question**: Does Measles vaccination rate improve with better socio-economic conditions?

**Secondary Questions**:

- 1. Which states have the highest and lowest vaccination rates?
- 2. What is the average income in the states with the highest and lowest vaccination rate?
- 3. Is the MMR vaccination rate higher in private schools?
- 4. How does the MMR vaccination rate compare to the school's overall vaccination rate?


# Analysis and findings

## Is the MMR vaccination rate higher in private schools?

The data was filtered to remove missing school type, overall vaccination rate and MMR rate. It was grouped by type and the average MMR vaccination rate and overall vaccination rate was calculated using the _mean_ function. The tibble generated was named _school_type_average_. Then, the average MMR rates from the  _school_type_average_ tibble were plotted. The rates were annotated accordingly to draw attention to the difference between the MMR vaccination rate for each school type. 

Interestingly enough, the overall vaccination rate and the MMR vaccination rate was the highest in public schools when compared to the rates in Kindergartens and private schools. This is consistent with findings from a study conducted by Shaw (2014) where it was found that private schools have higher rates of exemptions for immunisations than public schools. 

```{r school-type-average}
school_type_average <- 
  measles %>%
  # remove missing data
  filter(type != "NA",
         mmr != -1,
         overall != -1) %>%
  # group by type of school
  group_by(type) %>%
  # calculate the average mmr rate and overall rate according to type of school
  summarise(average_mmr_rate = mean(mmr),
            average_vacc_rate = mean(overall)) 
```

```{r ggplot-MMR-school-type}
ggplot(school_type_average,
       aes(x = "",
           y = average_mmr_rate,
           group = type)) +
  geom_bar(stat = "identity", width = 1) +
  facet_wrap(~type) +
  # convert to a pie chart
  coord_polar("y", start = 0) +
  # get rid of axis labels
  theme_void() +
  # add a percentage label to each segment which is colour co-ordinated
  geom_label_repel(label = percent(school_type_average$average_mmr_rate/100),
                  size= 3,
                   show.legend = F) +
  ggtitle("The Average MMR Vaccination Rate according to School Type")
```

## How does the MMR vaccination rate compare to the school's overall vaccination rate?

The _school_type_average_ was tabulated to compare the overall vaccination rate and MMR vaccination rate. Then, both rates were plotted according to school type. 

```{r summary-overall-mmr}
school_type_average %>%
  mutate(average_mmr_rate = percent(average_mmr_rate/100),
         average_vacc_rate = percent(average_vacc_rate/100)) %>%
  kable(col.names = c("Type",
                      "Average MMR Vaccination Rate",
                      "Average Overall Vaccination Rate"),
        caption = "Comparison of both Average Vaccination Rates according to School Type") %>%
  kable_styling(full_width = TRUE)
```

```{r compare-vacc-rates}
vacc_rates <- school_type_average %>%
   rename(MMR = average_mmr_rate,
         Overall = average_vacc_rate) %>%
  pivot_longer(cols = c("Overall", "MMR"),
               names_to = "vaccine_type",
               values_to = "rate") 
```

When comparing the vaccination


```{r vacc-rates-ggplot}
ggplot(vacc_rates,
         aes(x = vaccine_type,
             y = rate,
             group = type)) +
  geom_col() +
  facet_wrap(~type) +
  xlab("Type of Vaccination") + 
  ylab("Average Vaccination Rate") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.text.y = element_blank()) +
  geom_label_repel(label = percent(vacc_rates$rate/100),
                  size= 3,
                   show.legend = F) +
  ggtitle("Comparison of both Average Vaccination Rates according to School Type")
```

# Aryan section

NOTE - I have filled with the colours to match, but i dont know if that looks any good so we can change!

## Question 1
- grouped by states, found mean mmr and overall 
- used map_data to plot the map, creates a tibble of the geogrpahical info of states (lat,long,)
- then merged with measles_states, filtered out missing values <0, then plotted with geom polygon
- then sketched a bar chart


```{r density-summary}
# Measles vaccination across all American states and school count
measles_density <- measles %>%
  group_by(state) %>%
  summarise(mmr = mean(mmr),
            overall = mean(overall),
            count = n())

# Measles vaccination across state
measles_states <- measles_density[c("state", 
                                    "mmr", 
                                    "overall")] %>%
  rename(region = state) %>%
  mutate(region = tolower(region))
```

```{r map-data}
# Use map_data() to create usa mapping dataframe
usa <- map_data("state")

# Merging usa map data with measles across state data
usa_measles_states <- merge(usa, 
                            measles_states, 
                            all.x = TRUE)

# finding centroids and abb of each state
states <- st_as_sf(map("state", 
                       plot = FALSE, 
                       fill = TRUE))
states <- cbind(states, 
                st_coordinates(st_centroid(states)))
states$abb <- state.abb[match(states$ID,tolower(state.name))]

# Merging measles state data and usa map data with centroid data
usa_measles_states <- merge(usa_measles_states, 
                            states[c("ID", "X", "Y", "abb")], 
                            by.x = "region", 
                            by.y = "ID") %>%
  ungroup() %>%
  arrange(order)

usa_measles_states_overall <- usa_measles_states %>%
  filter(overall > 0)

usa_measles_states_mmr <- usa_measles_states %>%
  filter(mmr > 0)
```

```{r mmr-map}
# MMR vaccination rate across the states
mmr_p <- ggplotly(ggplot(usa_measles_states_mmr, aes(long, 
                                            lat, 
                                            group=group, 
                                            fill=mmr)) +
  geom_polygon(color = "light grey") +
  geom_text(aes(X, Y, 
                label = abb), 
            size = 4,
            color = "white",
            family = "sans") +
  ggtitle("MMR Vaccination Rate across States") +
  xlab("Latitude") +
  ylab("Longitude") + 
  theme(legend.position = "none"))
mmr_p
```

```{r overall-map}
# Overall vaccination rate across states
overall_p <- ggplotly(ggplot(usa_measles_states_overall, 
                    aes(long, 
                        lat, 
                        group=group, 
                        fill=overall)) +
  geom_polygon(color="light grey")+
  geom_text(aes(X, Y, label = abb), 
            size = 4,
            color="white",
            family="sans") +
  ggtitle("Overall Vaccination Rate Across States") +
  xlab("Latitude") +
  ylab("Longitude") +
  theme(legend.position = "none"))
overall_p
```

```{r overall-state-plot}
measles_density_overall <- measles_density %>%
  filter(overall > 0)

p_overall <- ggplot(measles_density_overall, 
                    aes(y = fct_reorder(state,
                                        overall), 
                        x = overall,
                        fill = overall)) +
  geom_col() +
  xlab("Overall Vaccination Rate") +
  ylab("") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  geom_label_repel(label = percent(measles_density_overall$overall/100),
                  size= 2,
                  color = "white",
                  show.legend = F) 
```

```{r mmr-state-plot}
measles_density_mmr <- measles_density %>%
  filter(mmr > 0)

p_mmr <- ggplot(measles_density_mmr, 
                aes(y = fct_reorder(state, 
                                    mmr),
                    x = mmr,
                    fill = mmr)) +
  geom_col() +
  xlab("MMR Vaccination Rate") +
  ylab("") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  geom_label_repel(label = percent(measles_density_mmr$mmr/100),
                  size= 2,
                  color = "white",
                  show.legend = F) 
```

```{r}
ggpubr::ggarrange(p_overall, 
                  p_mmr, 
                  nrow=1)
```

## Question 2

- external dataset from taxfoundation (add link), merged that data with the measles density data
- tabulated and then plotted in geomcol (income per capita against the vaccination rate for overall then mmr), then gg arrange to plot side by side
- 

```{r measles-density-income}
measles_density_mmr_income <- measles_density_mmr %>% 
  merge(state_income[c("stateName", 
                       "incomePerCapita")], 
        by.x = "state", 
        by.y = "stateName")
```

```{r best-mmr}
measles_density_mmr_income %>%
  select(state, 
         mmr, 
         incomePerCapita) %>%
  mutate(mmr = percent(measles_density_mmr_income$mmr/100)) %>%
  rename(State = state, 
         MMR = mmr, 
         PCI = incomePerCapita) %>%
  arrange(desc(MMR)) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  kable(caption = "The PCI of the States with the Highest MMR Vaccination Rate") %>%
  kable_styling()
```

```{r worst-mmr}
measles_density_mmr_income %>%
  select(state, 
         mmr, 
         incomePerCapita) %>%
    mutate(mmr = percent(measles_density_mmr_income$mmr/100)) %>%
  rename(State = state, 
         MMR = mmr, 
         PCI = incomePerCapita) %>%
  arrange(MMR) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  kable(caption = "The PCI of the States with the Lowest MMR Vaccination Rate") %>%
  kable_styling()
```




```{r mmr-income-plot}
p_mmr_income <- ggplot(measles_density_mmr_income, 
                       aes(y = fct_reorder(state,
                                           mmr))) +
  geom_col(aes(x = incomePerCapita)) +
  xlab("Income Per Capita") +
  ylab("") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  geom_label_repel(aes(x = incomePerCapita),
                  label = dollar(measles_density_mmr_income$incomePerCapita),
                  size= 2,
                  show.legend = F) 
```

```{r arrange-mmr-income}
ggarrange(p_mmr, 
          p_mmr_income, 
          nrow = 1)
```

```{r merge-measles-overall-income}
measles_density_overall_income <- measles_density_overall %>%
  merge(state_income[c("stateName", 
                       "incomePerCapita")], 
        by.x = "state", 
        by.y = "stateName")
```

```{r best-overall}
measles_density_overall_income %>%
  select(state, 
         overall, 
         incomePerCapita) %>%
  mutate(overall = percent(measles_density_overall_income$overall/100)) %>%
  rename(State = state, 
         Overall = overall, 
         PCI = incomePerCapita) %>%
  arrange(desc(Overall)) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  kable(caption = "The PCI of the States with the Highest Overall Vaccination Rate") %>%
  kable_styling()
```

```{r worst-overall}
measles_density_overall_income %>%
  select(state, 
         overall, 
         incomePerCapita) %>%
  mutate(overall = percent(measles_density_overall_income$overall/100)) %>%
  rename(State = state, 
         Overall = overall, 
         PCI = incomePerCapita) %>%
  arrange(Overall) %>%
  mutate(PCI = dollar(PCI)) %>%
  head(5) %>%
  kable(caption = "The PCI of the States with the Lowest Overall Vaccination Rate") %>%
  kable_styling()
```

```{r overall-income-plot}
p_overall_income <- ggplot(measles_density_overall_income, 
                           aes(y = fct_reorder(state,
                                               overall))) +
  geom_col(aes(x = incomePerCapita)) +
  xlab("Income Per Capita") +
  ylab("") +
  theme(axis.ticks = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  geom_label_repel(aes(x = incomePerCapita),
                  label = dollar(measles_density_overall_income$incomePerCapita),
                  size= 2,
                  show.legend = F) 
```

```{r arrange-overall-income}
ggarrange(p_overall, 
          p_overall_income, 
          nrow = 1)
```

# References

https://github.com/TaxFoundation/facts-and-figures

## Emily's references (I will fix up in APA)
measles definition - https://www.health.gov.au/health-topics/measles#what-is-measles

how vaccine works - https://www.health.qld.gov.au/news-events/news/what-is-measles-why-vaccinate#:~:text=The%20measles%20vaccine%20contains%20a,is%20better%20prepared%20to%20respond.

why people arent vaccinating - Cockcroft, A., Usman, M. U., Nyamucherera, O. F., Emori, H., Duke, B., Umar, N. A., & Andersson, N. (2014). Why children are not vaccinated against measles: a cross-sectional study in two Nigerian States. Archives of Public Health = Archives Belges de Sante Publique, 72(1), 48. 

effectiveness stat - Barrabeig, I., Rovira, A., Rius, C., Muñoz, P., Soldevila, N., Batalla, J., & Domínguez, A. (2011). Effectiveness of measles vaccination for control of exposed children. The Pediatric Infectious Disease Journal, 30(1), 78–80.

growing number of refusal - Phadke, V. K., Bednarczyk, R. A., Salmon, D. A., & Omer, S. B. (2016). Association Between Vaccine Refusal and Vaccine-Preventable Diseases in the United States: A Review of Measles and Pertussis. JAMA: The Journal of the American Medical Association, 315(11), 1149–1158.

28 times - Sinclair, D. R., Grefenstette, J. J., Krauland, M. G., Galloway, D. D., Frankeny, R. J., Travis, C., Burke, D. S., & Roberts, M. S. (2019). Forecasted Size of Measles Outbreaks Associated With Vaccination Exemptions for Schoolchildren. JAMA Network Open, 2(8), e199768.

public higher than private - Shaw, J., Tserenpuntsag, B., McNutt, L.-A., & Halsey, N. (2014). United States private schools have higher rates of exemptions to school immunization requirements than public schools. The Journal of Pediatrics, 165(1), 129–133.
